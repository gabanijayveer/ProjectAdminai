{% extends "base.html" %}

{% block title %}AI Data Chat - Admin Interface{% endblock %}

{% block extra_css %}
<style>
/* Markdown renderer styles for AI responses */
.message.ai .message-content {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    font-family: 'Segoe UI', sans-serif;
    line-height: 1.6;
    color: #333;
}

/* Markdown styles */
.message.ai .message-content h1,
.message.ai .message-content h2,
.message.ai .message-content h3 {
    margin-top: 1.2em;
    margin-bottom: 0.6em;
}

.message.ai .message-content code {
    background: #f1f1f1;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
}

.message.ai .message-content pre {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 15px;
    overflow: auto;
    border-radius: 6px;
    font-size: 14px;
}

.message.ai .message-content table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.message.ai .message-content th,
.message.ai .message-content td {
    border: 2px solid #333;
    padding: 10px;
    text-align: left;
}

.message.ai .message-content th {
    background-color: #e0e0e0;
    font-weight: bold;
}

.message.ai .message-content tr:nth-child(even) {
    background-color: #f9f9f9;
}

.message.ai .message-content tr:hover {
    background-color: #f1f1f1;
}


</style>
{% endblock %}

{% block content %}
<!-- Main Content -->
<div class="main-content">
    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-comments"></i>
                AI Assistant
            </div>
            <div class="status-badges">
                <span class="badge online">Online</span>
                <span class="badge session" id="sessionBadge">{{session_id}}</span>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messagesContainer">
            <!-- Welcome Message -->
            <div class="message ai">
                <div class="message-bubble">
                    <div class="message-header">AI Assistant</div>
                    <div class="message-content">
                        üëã Hello! I'm your AI data assistant powered by Proceduremanager.py.
                        Ask me anything about your data - I can analyze, query, and provide insights!
                        <br><br>
                        <strong>Try asking:</strong>
                        <ul>
                            <li>"Show me the top performing employees"</li>
                            <li>"Analyze sales trends for this quarter"</li>
                            <li>"Generate statistical analysis of customer data"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Container -->
        <div class="input-container">
            <form class="input-form" id="chatForm">
                <div class="input-wrapper">
                    <textarea
                        class="message-input"
                        id="messageInput"
                        placeholder="Ask me anything about your data..."
                        rows="1"
                        required
                    ></textarea>
                </div>
                <button type="submit" class="send-btn" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Recent Chats -->
        <div class="sidebar-card">
            <div class="sidebar-header">
                <i class="fas fa-history"></i>
                Recent Chats
            </div>
            <div class="sidebar-content" id="recentChats">
                <!-- Recent chats will be loaded here -->
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="sidebar-card">
            <div class="sidebar-header">
                <i class="fas fa-bolt"></i>
                Quick Actions
            </div>
            <div class="sidebar-content">
                <div class="recent-chat" onclick="insertQuery('Show me user statistics')">
                    <div class="chat-preview">User Statistics</div>
                    <div class="chat-meta">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                </div>
                <div class="recent-chat" onclick="insertQuery('List all employees')">
                    <div class="chat-preview">Employee List</div>
                    <div class="chat-meta">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="recent-chat" onclick="insertQuery('Performance analysis')">
                    <div class="chat-preview">Performance Analysis</div>
                    <div class="chat-meta">
                        <i class="fas fa-trophy"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// Modern chat functionality
const messagesContainer = document.getElementById('messagesContainer');
const messageInput = document.getElementById('messageInput');
const chatForm = document.getElementById('chatForm');
const sendBtn = document.getElementById('sendBtn');
let typingIndicator = null;

let currentExecutionId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    messageInput.focus();
    autoResizeTextarea();
    loadRecentChats();
});

// Auto-resize textarea
function autoResizeTextarea() {
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
}

// Handle form submission
chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage('user', message);
    messageInput.value = '';
    messageInput.style.height = 'auto';

    // Show typing indicator
    showTyping();

    try {
        // Send to backend
        const response = await fetch('/api/execute_query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: message,
                session_id: '{{session_id}}',
                token: '123456'
            })
        });

        const data = await response.json();

        if (response.ok) {
            currentExecutionId = data.execution_id;
            // Start polling for results
            pollForResults();
        } else {
            hideTyping();
            addMessage('ai', `Error: ${data.error}`);
        }
    } catch (error) {
        hideTyping();
        addMessage('ai', 'Sorry, there was a connection error. Please try again.');
    }
});

// Add message to chat
function addMessage(sender, content, qualityScore = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;

    const timestamp = new Date().toLocaleTimeString();
    const header = sender === 'user' ? 'You' : 'AI Assistant';

    let qualityBadge = '';
    if (qualityScore !== null) {
        qualityBadge = `<span class="quality-badge" style="background: #000000; color: #ffffff; border: 1px solid #000000; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 8px;">Quality: ${qualityScore}/100</span>`;
    }

    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div class="message-header">${header} ‚Ä¢ ${timestamp}${qualityBadge}</div>
            <div class="message-content">${formatMessageContent(content, sender)}</div>
        </div>
    `;

    messagesContainer.appendChild(messageDiv);
    scrollToBottom();
}

// Format message content - SIMPLIFIED: Direct display
function formatMessageContent(content, sender) {
    // Handle array content (from execution results)
    if (Array.isArray(content)) {
        content = content.join('\n');
    }

    // Ensure content is a string
    if (typeof content !== 'string') {
        content = String(content);
    }

    // For AI responses, use markdown rendering directly
    if (sender === 'ai') {
        return renderMarkdown(content);
    }

    return content.replace(/\n/g, '<br>');
}

// REMOVED: Complex markdown detection - now always render as markdown for AI responses

// Simple markdown renderer - direct conversion
function renderMarkdown(content) {
    try {
        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true,
            tables: true,
            sanitize: false,
            headerIds: false,
            mangle: false
        });

        // Convert content to string if needed
        let markdownText;
        if (Array.isArray(content)) {
            markdownText = content.join('\n');
        } else {
            markdownText = String(content);
        }

        // Parse and return HTML (pagination will be applied after DOM insertion)
        return marked.parse(markdownText);
    } catch (error) {
        console.error('Error rendering markdown:', error);
        return `<pre>${escapeHtml(String(content))}</pre>`;
    }
}



// REMOVED: Helper function - now using simple renderMarkdown for everything

// REMOVED: formatExecutionResults - now using direct markdown rendering

// Poll for execution results
async function pollForResults() {
    if (!currentExecutionId) return;

    try {
        const response = await fetch(`/api/execution_status/${currentExecutionId}`);
        const data = await response.json();

        if (data.status === 'completed') {
            hideTyping();
            addMessage('ai', data.execution_results, data.quality_score);
            // Reload recent chats after successful execution
            setTimeout(() => loadRecentChats(), 1000);
            currentExecutionId = null;
        } else if (data.status === 'error') {
            hideTyping();
            addMessage('ai', `Error: ${data.error}`);
            currentExecutionId = null;
        } else {
            // Continue polling
            setTimeout(pollForResults, 2000);
        }
    } catch (error) {
        hideTyping();
        addMessage('ai', `Error polling results: ${error.message}`);
        currentExecutionId = null;
    }
}

// Display execution results
function displayExecutionResults(results, qualityScore) {
    if (!results || results.length === 0) {
        addMessage('ai', 'No results found.');
        return;
    }

    let content = '';

    // Create execution results display
    content += '<div class="execution-results">';
    content += '<div class="results-header">EXECUTION RESULTS</div>';

    results.forEach(line => {
        content += `<div class="result-line">${escapeHtml(line)}</div>`;
    });

    content += '</div>';

    addMessage('ai', content, qualityScore);
}



// Show/hide typing indicator
function showTyping() {
    // Remove existing typing indicator if any
    hideTyping();

    // Create new typing indicator
    typingIndicator = document.createElement('div');
    typingIndicator.className = 'typing-indicator message ai';
    typingIndicator.innerHTML = `
        <div class="message-bubble">
            <div class="message-header">AI Assistant ‚Ä¢ Processing...</div>
            <div class="message-content">
                <div class="typing-dots">
                    AI is thinking
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;

    // Add to messages container
    messagesContainer.appendChild(typingIndicator);
    scrollToBottom();
}

function hideTyping() {
    if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
        typingIndicator = null;
    }
}

// Scroll to bottom
function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Insert predefined query
function insertQuery(query) {
    messageInput.value = query;
    messageInput.focus();
}

// Load recent chats
async function loadRecentChats() {
    try {
        console.log('Loading recent chats...');
        const response = await fetch('/history/recent');
        const data = await response.json();

        console.log('Recent chats data:', data);

        const recentChatsContainer = document.getElementById('recentChats');
        if (!recentChatsContainer) {
            console.log('Recent chats container not found');
            return;
        }

        recentChatsContainer.innerHTML = '';

        if (data && data.length > 0) {
            console.log(`Displaying ${data.length} recent chats`);
            data.forEach((chat, index) => {
                const chatDiv = document.createElement('div');
                chatDiv.className = 'recent-chat';
                chatDiv.style.cssText = 'padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;';

                const timeStr = chat.timestamp ? new Date(chat.timestamp).toLocaleDateString() : 'Unknown';
                const qualityBadge = chat.quality_score ? `<span style="background: #10b981; color: white; padding: 1px 4px; border-radius: 2px; font-size: 0.6rem; margin-left: 4px;">Q:${chat.quality_score}</span>` : '';

                chatDiv.innerHTML = `
                    <div class="chat-preview" style="font-size: 0.9rem; font-weight: 500; color: #000000; margin-bottom: 6px;">
                        ${escapeHtml(chat.query.substring(0, 45))}${chat.query.length > 45 ? '...' : ''}
                        ${qualityBadge}
                    </div>
                    <div class="chat-meta" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #666666;">
                        <span>${timeStr}</span>
                        <span class="session-badge" style="background: #6b7280; color: #ffffff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">${chat.session_id}</span>
                    </div>
                `;

                chatDiv.addEventListener('click', () => {
                    console.log('Inserting query:', chat.query);
                    insertQuery(chat.query);
                });

                chatDiv.addEventListener('mouseenter', () => {
                    chatDiv.style.background = '#f0f0f0';
                });

                chatDiv.addEventListener('mouseleave', () => {
                    chatDiv.style.background = 'transparent';
                });

                recentChatsContainer.appendChild(chatDiv);
            });
        } else {
            console.log('No recent chats found');
            recentChatsContainer.innerHTML = `
                <div style="text-align: center; color: #666666; font-style: italic; padding: 20px;">
                    No recent chats
                    <br>
                    <small style="color: #999999;">Start a conversation to see recent chats here</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load recent chats:', error);
        const recentChatsContainer = document.getElementById('recentChats');
        if (recentChatsContainer) {
            recentChatsContainer.innerHTML = '<div style="text-align: center; color: #ff0000; font-style: italic; padding: 20px;">Failed to load recent chats</div>';
        }
    }
}



// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Enter to send (Shift+Enter for new line)
messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
    }
});

// Utility function to save markdown content as file (optional feature)
function saveMarkdownToFile(content, filename = 'report.md') {
    try {
        const blob = new Blob([content], { type: 'text/markdown' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
        console.log(`Markdown saved as ${filename}`);
    } catch (error) {
        console.error('Error saving markdown file:', error);
    }
}

// Test function with table pagination (using your demo logic)
function testMarkdownRendering() {
    const sampleMarkdown = `**Description:** This report provides a list of all registered users in the system, demonstrating table pagination with "Show More" functionality.

### üìä Key Metrics
- Total Registered Users: 10
- Showing first 5 rows with pagination

### üìã Data Tables

| User ID | First Name | Last Name | Email | Registration Date |
|---|---|---|---|---|
| 91 | Kara | Presley | kara.presley@example.com | 2025-08-01 09:44:04 |
| 90 | Jake | Orion | jake.orion@example.com | 2025-08-01 09:44:04 |
| 89 | Isla | Nash | isla.nash@example.com | 2025-08-01 09:44:04 |
| 88 | Hugo | Matthews | hugo.matthews@example.com | 2025-08-01 09:44:04 |
| 87 | Grace | Lloyd | grace.lloyd@example.com | 2025-08-01 09:44:04 |
| 86 | Felix | Keller | felix.keller@example.com | 2025-08-01 09:44:04 |
| 85 | Elise | Jameson | elise.jameson@example.com | 2025-08-01 09:44:04 |
| 84 | Derek | Innes | derek.innes@example.com | 2025-08-01 09:44:04 |
| 83 | Clara | Hayes | clara.hayes@example.com | 2025-08-01 09:44:04 |
| 82 | Blake | Grimes | blake.grimes@example.com | 2025-08-01 09:44:04 |

### üí° Conclusions
**Conclusion:** This table demonstrates the pagination feature - first 5 rows are shown with a "Show More" button to reveal additional rows.`;

    addMessage('ai', sampleMarkdown);
}

// Test function for conversation scenarios
function testConversationScenarios() {
    // Test simple greeting
    addMessage('ai', "Hello! How can I help you today?");

    setTimeout(() => {
        // Test data in process (no empty tables shown)
        const dataInProcess = `**Description:** Data might be in process

### üìä Key Metrics
- Status: No data available at this time

### üí° Conclusions
**Conclusion:** The requested data might be in process. Please try again later or check if the data source is available.`;

        addMessage('ai', dataInProcess);
    }, 2000);

    setTimeout(() => {
        // Test empty table scenario (should not show Data Tables section)
        const emptyTableTest = `**Description:** Query executed but no data found

### üìä Key Metrics
- Status: Query completed successfully
- Records Found: 0

### üí° Conclusions
**Conclusion:** No data tables section will be displayed when there are no data rows, preventing empty table headers from showing.`;

        addMessage('ai', emptyTableTest);
    }, 4000);
}

// Test function for performance optimization (safe)
function testPerformanceOptimization() {
    console.log('üîß Testing Performance Optimization Fixes:');
    console.log('‚ùå Fixed: No USE INDEX hints (indexes may not exist)');
    console.log('‚ùå Fixed: No CREATE INDEX statements');
    console.log('‚úÖ Safe: Simple procedures without complex cursors');
    console.log('‚úÖ Safe: Comments-only optimization hints');

    const optimizationTest = `**Description:** Procedure optimization issues have been resolved

### üìä Key Metrics
- Status: USE INDEX hints removed
- Optimization: Simple procedures without index dependencies
- Performance: Reliable execution without database errors
- Compatibility: Works with any database setup

### üí° Conclusions
**Conclusion:** Your procedure will now work reliably without USE INDEX hints, CREATE INDEX statements, or complex cursor operations that can cause execution failures.`;

    addMessage('ai', optimizationTest);
}

// Add test buttons for different scenarios
function addTestButtons() {
    // Test normal markdown
    const testBtn1 = document.createElement('button');
    testBtn1.textContent = 'Test Data';
    testBtn1.style.cssText = 'position: fixed; top: 10px; right: 230px; z-index: 1000; padding: 8px 12px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
    testBtn1.onclick = testMarkdownRendering;
    document.body.appendChild(testBtn1);

    // Test conversation scenarios
    const testBtn2 = document.createElement('button');
    testBtn2.textContent = 'Test Chat';
    testBtn2.style.cssText = 'position: fixed; top: 10px; right: 120px; z-index: 1000; padding: 8px 12px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
    testBtn2.onclick = testConversationScenarios;
    document.body.appendChild(testBtn2);

    // Test performance optimization
    const testBtn3 = document.createElement('button');
    testBtn3.textContent = 'Test Perf';
    testBtn3.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 8px 12px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';
    testBtn3.onclick = testPerformanceOptimization;
    document.body.appendChild(testBtn3);
}



// Add test button functionality (for development/testing)
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    console.log('üß™ Development mode: Multiple test scenarios available');
    console.log('üí¨ testConversationScenarios() - chat responses');
    console.log('‚ö° testPerformanceOptimization() - performance fixes');
    console.log('üìã Table pagination: Using your demo logic (header + 5 rows, then Show More)');
    console.log('‚úÖ CREATE INDEX issue resolved - safe optimization hints only');
    // Add test buttons after page loads
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(addTestButtons, 1000);
    });
}

</script>
{% endblock %}



